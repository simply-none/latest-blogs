# promise å¯¹è±¡

## æ¦‚å¿µ

1. promise æ˜¯ä¸€ç§å¼‚æ­¥ç¼–ç¨‹è§£å†³æ–¹æ¡ˆ
2. promise å¯¹è±¡çš„çŠ¶æ€ä¸å—å¤–ç•Œå½±å“ï¼Œåªæœ‰å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œå¯ä»¥çŸ¥é“æ­¤åˆ»å¤„äºä½•ç§çŠ¶æ€ï¼ˆpendingã€fulfilledã€rejectedï¼‰
3. promise å¯¹è±¡çš„çŠ¶æ€ä¸€æ—¦æ”¹å˜ï¼Œå°±ä¸ä¼šå†æ¬¡å˜åŒ–ï¼ˆpending->fulfilledã€pending->rejectedï¼‰ï¼Œå½“çŠ¶æ€æ”¹å˜å®Œæˆï¼Œåœ¨å¯¹ promise å¯¹è±¡æ·»åŠ å›è°ƒå‡½æ•°ï¼Œä¾ç„¶è¿”å›åŸå…ˆçš„ç»“æœ
4. promise å¯¹è±¡å¯ä»¥å°†å¼‚æ­¥æ“ä½œæµç¨‹ä»¥åŒæ­¥æ“ä½œæµç¨‹è¡¨è¾¾å‡ºæ¥ï¼Œé¿å…äº†å±‚å±‚åµŒå¥—
5. promise å¯¹è±¡æ— æ³•å–æ¶ˆï¼Œä¸€æ—¦åˆ›å»ºå°±ç«‹å³æ‰§è¡Œ
6. è‹¥ä¸è®¾ç½®å›è°ƒå‡½æ•°ï¼Œpromise å¯¹è±¡å†…éƒ¨æŠ›å‡ºçš„é”™è¯¯ï¼Œä¸ä¼šåæ˜ åˆ°å¤–éƒ¨
7. å½“å¤„äº pending çŠ¶æ€æ—¶ï¼Œæ— æ³•å¾—çŸ¥ç›®å‰è¿›å±•åˆ°ä½•ç§é˜¶æ®µ
8. å½“æŸäº›äº‹ä»¶ä¸æ–­çš„åå¤å‘ç”Ÿï¼Œä½¿ç”¨ stream æ¨¡å¼æ¯”éƒ¨ç½² promise æ›´å¥½

## åŸºæœ¬ç”¨æ³•

1. new Promise()ï¼šåˆ›å»º promise å®ä¾‹ ğŸŒ°ï¼Œ
   1. å…¶ä¸­ç¬¬ä¸€ä¸ªå‡½æ•°å‚æ•°ä¸­ï¼Œresolve å‡½æ•°æ˜¯å°† promise çŠ¶æ€ä» pending->resolvedï¼Œå¹¶å°†å¼‚æ­¥æ“ä½œçš„ç»“æœï¼ˆå‡½æ•°å‚æ•°ï¼‰ï¼Œä½œä¸ºå‚æ•°ä¼ é€’å‡ºå»ï¼›reject å‡½æ•°æ•ˆæœç±»ä¼¼
   2. promise å®ä¾‹æ–°å»ºåï¼Œå›è°ƒå‡½æ•°ä¼šç«‹å³æ‰§è¡Œï¼ˆæ˜¯åŒæ­¥çš„ï¼‰ï¼Œåªç”¨ then ç­‰é“¾å¼è°ƒç”¨æ˜¯å¼‚æ­¥çš„
   3. resolve å‡½æ•°å‚æ•°å¯ä»¥æ˜¯å¦ä¸€ä¸ª promise å®ä¾‹
   4. promise å®ä¾‹çš„å‚æ•°å›è°ƒå‡½æ•°ä¸­çš„ resolve å‡½æ•°ä¼šåœ¨å›è°ƒå‡½æ•°å†…éƒ¨æ‰€æœ‰çš„åŒæ­¥æ“ä½œæ‰§è¡Œå®Œå†æ‰§è¡Œï¼Œä¸ºäº†é¿å…å‘ç”Ÿæ„å¤–ï¼Œå¯ä½¿ç”¨å¯¹ resolve ä½¿ç”¨ return æ“ä½œï¼Œé˜²æ­¢åé¢ä»£ç è¢«æ‰§è¡Œ
   5. promise å†…éƒ¨çš„é”™è¯¯æ•è·ä¼ é€’åˆ°å¤–éƒ¨ï¼Œå³ä¸ä¼šå½±å“åˆ°å¤–éƒ¨ä»£ç çš„æ­£å¸¸æ‰§è¡Œ
2. Promise.prototype.then(resolvedFn, rejectedFn)
   1. ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯å›è°ƒå‡½æ•°ï¼Œéƒ½æ˜¯å¯é€‰çš„
   2. then æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„ promise å®ä¾‹ï¼ˆä¸æ˜¯åŸæ¥çš„ï¼‰ï¼Œæ•…è€Œå¯ç”¨äºé“¾å¼æ“ä½œ
3. Promise.prototype.catch(errFn)ğŸ
   1. å½“ catch å‰é¢çš„å¼‚æ­¥æ“ä½œé“¾æ¡ä¸­æŸç¯èŠ‚æŠ›å‡ºé”™è¯¯ï¼Œå°±ä¼šæ‰§è¡Œè¯¥æ–¹æ³•
   2. catch æ–¹æ³•è¿”å›ä¸€ä¸ª promise å®ä¾‹ï¼Œæ•…è€Œå¯ç”¨äºé“¾å¼æ“ä½œ
   3. ç­‰åŒäº Promise.prototype.then(null/undefined, errFn)ï¼Œä¸€èˆ¬ä¸ä½¿ç”¨è¿™æ–¹æ³•ï¼Œå› ä¸º then å†…éƒ¨çš„æ–¹æ³•ä¹Ÿå¯ä»¥è¢« catch æ•è·
   4. è‹¥ promise çŠ¶æ€å·²ç»å˜ä¸º resolvedï¼Œå†æ¬¡æŠ›å‡ºé”™è¯¯æ˜¯æ— æ•ˆçš„ï¼Œæ¯”å¦‚åœ¨æ„é€ å‡½æ•°çš„å›è°ƒå‡½æ•°ä¸­`resolve(); throw new Error()`ï¼Œè¿™æ˜¯æ— æ•ˆçš„
4. Promise.prototype.finally(callback)
   1. ç”¨äºæŒ‡å®šä¸ç®¡ promise å¯¹è±¡çš„çŠ¶æ€æœ€ç»ˆå¦‚ä½•ï¼Œéƒ½ä¼šæ‰§è¡Œçš„æ“ä½œ
   2. å…¶ä¸­å›è°ƒå‡½æ•° callback ä¸æ¥å—ä»»ä½•å‚æ•°ï¼Œå³æ— æ³•çŸ¥é“å‰é¢çš„ promise çš„çŠ¶æ€å¦‚ä½•ï¼Œæ‰€ä»¥å›è°ƒå‡½æ•°å†…éƒ¨çš„ä»£ç åº”è¯¥æ˜¯ä¸çŠ¶æ€æ— å…³çš„ï¼Œä¸ä¾èµ–äº promise çš„æ‰§è¡Œç»“æœ
5. Promise.all(promiseArray)
   1. å°†å¤šä¸ª promise å®ä¾‹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„ promise å®ä¾‹
   2. å…¶ä¸­å‚æ•°å¯ä»¥ä¸æ˜¯æ•°ç»„ï¼Œä½†å¿…é¡»è¦å…·å¤‡ä¸€ä¸ªè¿­ä»£å™¨æ¥å£ï¼Œä¸”è¿”å›çš„æ¯ä¸ªæˆå‘˜éƒ½æ˜¯ promise å®ä¾‹
   3. å®ä¾‹çš„çŠ¶æ€ç”±å‚æ•°ä¸­çš„æ‰€æœ‰å®ä¾‹å†³å®šï¼Œåªæœ‰å…¨éƒ¨ä¸º resolvedï¼Œæ‰ä¸º resolvedï¼Œæ­¤æ—¶æ‰€æœ‰å®ä¾‹çš„è¿”å›å€¼ç»„æˆæ•°ç»„ä¼ é€’ç»™åç»­é“¾ï¼›è‹¥æœ‰ä¸€ä¸ªæ˜¯ rejectedï¼Œåˆ™å˜ä¸º rejectedï¼Œç¬¬ä¸€ä¸ª rejected çš„è¿”å›å€¼ä¼ é€’ç»™åç»­é“¾
   4. è‹¥å‚æ•°çš„æŸäº›å®ä¾‹å…·å¤‡ catch æ–¹æ³•ï¼Œåˆ™è¿™äº›å®ä¾‹å‘ç”Ÿé”™è¯¯ä¸ä¼šè°ƒç”¨ all æ–¹æ³•é“¾æ¡çš„ catch æ–¹æ³•
6. Promise.race(promiseArray)
   1. å°†å¤šä¸ª promise å®ä¾‹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„ promise å®ä¾‹
   2. åªæœ‰å‚æ•°çš„ä¸€ä¸ªå®ä¾‹çŠ¶æ€ç‡å…ˆæ”¹å˜ï¼Œå®ƒä¹Ÿè·Ÿç€æ”¹å˜çŠ¶æ€ï¼Œæœ€å…ˆæ”¹å˜çŠ¶æ€çš„è¿”å›å€¼ï¼Œå°†ä¼ é€’ç»™åç»­é“¾
7. Promise.allSettled(promiseArray)
   1. å°†å¤šä¸ª promise å®ä¾‹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„ promise å®ä¾‹
   2. åªæœ‰æ‰€æœ‰çš„å®ä¾‹éƒ½è¿”å›ç»“æœï¼ˆfulfilled/rejectedï¼‰ï¼ŒåŒ…è£…å®ä¾‹æ‰ä¼šç»“æŸï¼Œä¸”çŠ¶æ€æ€»æ˜¯ fulfilled
   3. ç”¨é€”ï¼šä¸å…³ç³»æ“ä½œçš„ç»“æœï¼Œåªå…³å¿ƒå¼‚æ­¥æ“ä½œæ˜¯å¦ç»“æŸ
8. Promise.any(promiseArray)
   1. å°†å¤šä¸ª promise å®ä¾‹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„ promise å®ä¾‹
   2. è‹¥æœ‰ä¸€ä¸ªå‚æ•°å®ä¾‹çŠ¶æ€å˜ä¸º fulfilledï¼Œåˆ™åŒ…è£…å®ä¾‹çŠ¶æ€å˜ä¸º fulfilledï¼Œå½“æ‰€æœ‰å‚æ•°å®ä¾‹çŠ¶æ€å˜ä¸º rejected æ—¶ï¼ŒåŒ…è£…å®ä¾‹çŠ¶æ€æ‰ä¼šå˜ä¸º rejected
   3. any æŠ›å‡ºçš„é”™è¯¯ï¼Œæ˜¯ä¸€ä¸ª AggregateError å®ä¾‹ï¼Œç›¸å½“äºä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæˆå‘˜å¯¹åº”äºä¸€ä¸ª rejected æŠ›å‡ºçš„é”™è¯¯
9. Promise.resolve()
   1. å°†ç°æœ‰å¯¹è±¡è½¬ä¸º promise å¯¹è±¡ï¼Œç­‰ä»·äº`new Promise(resolve => resolve('foo'))`
   2. å‚æ•°åˆ†ä¸ºä»¥ä¸‹æƒ…å†µï¼š
      1. å‚æ•°æ˜¯ promise å®ä¾‹ï¼Œåˆ™è¯¥å‡½æ•°å°†åŸå°ä¸åŠ¨è¿”å›è¿™ä¸ªå®ä¾‹
      2. å‚æ•°æ˜¯ thenable å¯¹è±¡ï¼ˆå…·æœ‰ then æ–¹æ³•çš„å¯¹è±¡ï¼‰ï¼Œä¼šå°†è¿™ä¸ªå¯¹è±¡è½¬ä¸º promise å¯¹è±¡ï¼Œå¹¶æ‰§è¡Œ thenable å¯¹è±¡ä¸­çš„ then æ–¹æ³•
      3. å‚æ•°æ˜¯æ—  then æ–¹æ³•çš„å¯¹è±¡/ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ª promise å®ä¾‹ï¼ŒçŠ¶æ€ä¸º resolved
      4. æ— å‚ï¼Œè¿”å›ä¸€ä¸ª resolved çš„ promise å®ä¾‹
   3. æ³¨æ„ç«‹å³ resolved çš„å®ä¾‹ï¼Œæ˜¯åœ¨æœ¬è½®äº‹ä»¶å¾ªç¯ç»“æŸåæ‰§è¡Œï¼Œè€Œéä¸‹è½®å¾ªç¯å¼€å§‹æ—¶
10. Promise.reject()
    1. è¿”å›è¦ç»™æ–°çš„ promise å®ä¾‹ï¼Œå®ä¾‹çš„çŠ¶æ€ä¸º rejectedï¼Œç­‰ä»·äº`new Promise(reject => reject('å‡ºé”™äº†'))`
    2. è¯¥æ–¹æ³•çš„å‚æ•°ä¼šåŸå°ä¸åŠ¨çš„ä½œä¸ºåç»­é“¾çš„å‚æ•°
11. Promise.try()
    1. ä¸€ä¸ªææ¡ˆï¼Œä¸æƒ³åŒºåˆ†å‡½æ•°æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥çš„ï¼Œä½†éƒ½æƒ³ç”¨ promise æ¥å¤„ç†ä»–ä»¬ï¼Œå¹¶ä½¿ç”¨ promise çš„ API

```js
// ğŸŒ°ï¼šnew Promise()åˆ›å»ºpromiseå®ä¾‹
const promise = new Promise(function (resolve, reject) {
  // some code...
  if (/* å¼‚æ­¥æ“ä½œæˆåŠŸæ“ä½œ */) {
    resolve(value)
    // other sync codeï¼Œæ­¤å¤„çš„ä»£ç ä¼˜äºresolveå‡½æ•°æ‰§è¡Œ
  } else {
    reject(error)
  }
})

// ğŸï¼šcatch
const promise = new Promise(fucntion (resolve, reject) {
  throw new Error('test')
})

promise.catch(function (err) {
  console.log(err)
})

// ç­‰åŒäº
const promise = new Promise(function (resolve, reject) {
  try {
    throw new Error('test')
  } catch (e) {
    reject(e)
  }
})

promise.catch(fucntion (err) {
  console.log(err)
})

// ç­‰åŒäº
const promise = new Promise(function (resolve, reject) {
  reject(new Error('test'))
})

promise.catch(function (err) {
  console.log(err)
})
```

## åº”ç”¨

1. å›¾ç‰‡åŠ è½½ï¼šå½“å›¾ç‰‡åŠ è½½å®Œæˆæ—¶ï¼ŒçŠ¶æ€å˜ä¸º fulfilled
2. promise ä¸ generator ç»“åˆä½¿ç”¨ï¼šä½¿ç”¨ generator ç®¡ç†æµç¨‹æ—¶ï¼Œé‡åˆ°å¼‚æ­¥æ“ä½œï¼Œè¿”å›ä¸€ä¸ª promise
